{"ast":null,"code":"import _asyncToGenerator from \"C:\\\\dotnet\\\\Talic\\\\skinet\\\\client\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\asyncToGenerator.js\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/basket/basket.service\";\nimport * as i2 from \"../checkout.service\";\nimport * as i3 from \"ngx-toastr\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"@angular/forms\";\nimport * as i6 from \"../../shared/components/text-input/text-input.component\";\nimport * as i7 from \"@angular/common\";\nimport * as i8 from \"@angular/cdk/stepper\";\nconst _c0 = [\"cardNumber\"];\nconst _c1 = [\"cardExpiry\"];\nconst _c2 = [\"cardCvc\"];\n\nfunction CheckoutPaymentComponent_ng_container_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"span\", 17);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementContainerEnd();\n  }\n\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r1.cardErrors);\n  }\n}\n\nfunction CheckoutPaymentComponent_i_21_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"i\", 18);\n  }\n}\n\nexport class CheckoutPaymentComponent {\n  constructor(basketService, checkoutService, toastr, router) {\n    this.basketService = basketService;\n    this.checkoutService = checkoutService;\n    this.toastr = toastr;\n    this.router = router;\n    this.cardHandler = this.onChange.bind(this);\n    this.loading = false;\n    this.cardNumberValid = false;\n    this.cardExpiryValid = false;\n    this.cardCvcValid = false;\n  }\n\n  ngAfterViewInit() {\n    this.stripe = Stripe('pk_test_51KsunPL2Qn5rWsPpwSE9amT78iPHDHlkELaBAvApJ4FzNOj4biNmDtAtjx7VNtg788iPtkEQLLiPk158il9n19Xi00UQSa5c1o');\n    const elements = this.stripe.elements();\n    this.cardNumber = elements.create('cardNumber');\n    this.cardNumber.mount(this.cardNumberElement.nativeElement);\n    this.cardNumber.addEventListener('change', this.cardHandler);\n    this.cardExpiry = elements.create('cardExpiry');\n    this.cardExpiry.mount(this.cardExpiryElement.nativeElement);\n    this.cardExpiry.addEventListener('change', this.cardHandler);\n    this.cardCvc = elements.create('cardCvc');\n    this.cardCvc.mount(this.cardCvcElement.nativeElement);\n    this.cardCvc.addEventListener('change', this.cardHandler);\n  }\n\n  ngOnDestroy() {\n    this.cardNumber.destroy();\n    this.cardExpiry.destroy();\n    this.cardCvc.destroy();\n  }\n\n  onChange(event) {\n    if (event.error) {\n      this.cardErrors = event.error.message;\n    } else {\n      this.cardErrors = null;\n    }\n\n    switch (event.elementType) {\n      case 'cardNumber':\n        this.cardNumberValid = event.complete;\n        break;\n\n      case 'cardExpiry':\n        this.cardExpiryValid = event.complete;\n        break;\n\n      case 'cardCvc':\n        this.cardCvcValid = event.complete;\n        break;\n    }\n  }\n\n  submitOrder() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      _this.loading = true;\n\n      const basket = _this.basketService.getCurrentBasketValue();\n\n      try {\n        const createdOrder = yield _this.createOrder(basket);\n        const paymentResult = yield _this.confirmPaymentWithStripe(basket);\n\n        if (paymentResult.paymentIntent) {\n          _this.basketService.deleteBasket(basket);\n\n          const navigationExtras = {\n            state: createdOrder\n          };\n\n          _this.router.navigate(['checkout/success'], navigationExtras);\n        } else {\n          _this.toastr.error(paymentResult.error.message);\n        }\n\n        _this.loading = false;\n      } catch (error) {\n        console.log(error);\n        _this.loading = false;\n      }\n    })();\n  }\n\n  confirmPaymentWithStripe(basket) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      return _this2.stripe.confirmCardPayment(basket.clientSecret, {\n        payment_method: {\n          card: _this2.cardNumber,\n          billing_details: {\n            name: _this2.checkoutForm.get('paymentForm').get('nameOnCard').value\n          }\n        }\n      });\n    })();\n  }\n\n  createOrder(basket) {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      const orderToCreate = _this3.getOrderToCreate(basket);\n\n      return _this3.checkoutService.createOrder(orderToCreate).toPromise();\n    })();\n  }\n\n  getOrderToCreate(basket) {\n    return {\n      basketId: basket.id,\n      deliveryMethodId: this.checkoutForm.get('deliveryForm').get('deliveryMethod').value,\n      shipToAddress: this.checkoutForm.get('addressForm').value\n    };\n  }\n\n}\n\nCheckoutPaymentComponent.ɵfac = function CheckoutPaymentComponent_Factory(t) {\n  return new (t || CheckoutPaymentComponent)(i0.ɵɵdirectiveInject(i1.BasketService), i0.ɵɵdirectiveInject(i2.CheckoutService), i0.ɵɵdirectiveInject(i3.ToastrService), i0.ɵɵdirectiveInject(i4.Router));\n};\n\nCheckoutPaymentComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: CheckoutPaymentComponent,\n  selectors: [[\"app-checkout-payment\"]],\n  viewQuery: function CheckoutPaymentComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 7);\n      i0.ɵɵviewQuery(_c1, 7);\n      i0.ɵɵviewQuery(_c2, 7);\n    }\n\n    if (rf & 2) {\n      let _t;\n\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardNumberElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardExpiryElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardCvcElement = _t.first);\n    }\n  },\n  inputs: {\n    checkoutForm: \"checkoutForm\"\n  },\n  decls: 22,\n  vars: 5,\n  consts: [[1, \"mt-4\", 3, \"formGroup\"], [1, \"row\"], [\"formGroupName\", \"paymentForm\", 1, \"form-group\", \"col-12\"], [\"formControlName\", \"nameOnCard\", 3, \"label\"], [1, \"form-group\", \"col-6\"], [1, \"form-control\", \"py-3\"], [\"cardNumber\", \"\"], [4, \"ngIf\"], [1, \"form-group\", \"col-3\"], [\"cardExpiry\", \"\"], [\"cardCvc\", \"\"], [1, \"float-none\", \"d-flex\", \"justify-content-between\", \"flex-column\", \"flex-lg-row\", \"mb-5\"], [\"cdkStepperPrevious\", \"\", 1, \"btn\", \"btn-outline-primary\"], [1, \"fa\", \"fa-angle-left\"], [1, \"btn\", \"btn-primary\", 3, \"disabled\", \"click\"], [1, \"fa\", \"fa-angle-right\"], [\"class\", \"fa fa-spinner fa-spin\", 4, \"ngIf\"], [1, \"text-danger\"], [1, \"fa\", \"fa-spinner\", \"fa-spin\"]],\n  template: function CheckoutPaymentComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\", 0)(1, \"div\", 1)(2, \"div\", 2);\n      i0.ɵɵelement(3, \"app-text-input\", 3);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(4, \"div\", 4);\n      i0.ɵɵelement(5, \"div\", 5, 6);\n      i0.ɵɵtemplate(7, CheckoutPaymentComponent_ng_container_7_Template, 3, 1, \"ng-container\", 7);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(8, \"div\", 8);\n      i0.ɵɵelement(9, \"div\", 5, 9);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(11, \"div\", 8);\n      i0.ɵɵelement(12, \"div\", 5, 10);\n      i0.ɵɵelementEnd()()();\n      i0.ɵɵelementStart(14, \"div\", 11)(15, \"button\", 12);\n      i0.ɵɵelement(16, \"i\", 13);\n      i0.ɵɵtext(17, \" Back to Review \");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(18, \"button\", 14);\n      i0.ɵɵlistener(\"click\", function CheckoutPaymentComponent_Template_button_click_18_listener() {\n        return ctx.submitOrder();\n      });\n      i0.ɵɵtext(19, \" Submit order \");\n      i0.ɵɵelement(20, \"i\", 15);\n      i0.ɵɵtemplate(21, CheckoutPaymentComponent_i_21_Template, 1, 0, \"i\", 16);\n      i0.ɵɵelementEnd()();\n    }\n\n    if (rf & 2) {\n      i0.ɵɵproperty(\"formGroup\", ctx.checkoutForm);\n      i0.ɵɵadvance(3);\n      i0.ɵɵproperty(\"label\", \"Name on card\");\n      i0.ɵɵadvance(4);\n      i0.ɵɵproperty(\"ngIf\", ctx.cardErrors);\n      i0.ɵɵadvance(11);\n      i0.ɵɵproperty(\"disabled\", ctx.loading || ctx.checkoutForm.get(\"paymentForm\").invalid || !ctx.cardNumberValid || !ctx.cardExpiryValid || !ctx.cardCvcValid);\n      i0.ɵɵadvance(3);\n      i0.ɵɵproperty(\"ngIf\", ctx.loading);\n    }\n  },\n  directives: [i5.NgControlStatusGroup, i5.FormGroupDirective, i5.FormGroupName, i6.TextInputComponent, i5.NgControlStatus, i5.FormControlName, i7.NgIf, i8.CdkStepperPrevious],\n  styles: [\"\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsImZpbGUiOiJjaGVja291dC1wYXltZW50LmNvbXBvbmVudC5zY3NzIn0= */\"]\n});","map":{"version":3,"sources":["C:/dotnet/Talic/skinet/client/src/app/checkout/checkout-payment/checkout-payment.component.ts"],"names":["i0","i1","i2","i3","i4","i5","i6","i7","i8","_c0","_c1","_c2","CheckoutPaymentComponent_ng_container_7_Template","rf","ctx","ɵɵelementContainerStart","ɵɵelementStart","ɵɵtext","ɵɵelementEnd","ɵɵelementContainerEnd","ctx_r1","ɵɵnextContext","ɵɵadvance","ɵɵtextInterpolate","cardErrors","CheckoutPaymentComponent_i_21_Template","ɵɵelement","CheckoutPaymentComponent","constructor","basketService","checkoutService","toastr","router","cardHandler","onChange","bind","loading","cardNumberValid","cardExpiryValid","cardCvcValid","ngAfterViewInit","stripe","Stripe","elements","cardNumber","create","mount","cardNumberElement","nativeElement","addEventListener","cardExpiry","cardExpiryElement","cardCvc","cardCvcElement","ngOnDestroy","destroy","event","error","message","elementType","complete","submitOrder","basket","getCurrentBasketValue","createdOrder","createOrder","paymentResult","confirmPaymentWithStripe","paymentIntent","deleteBasket","navigationExtras","state","navigate","console","log","confirmCardPayment","clientSecret","payment_method","card","billing_details","name","checkoutForm","get","value","orderToCreate","getOrderToCreate","toPromise","basketId","id","deliveryMethodId","shipToAddress","ɵfac","CheckoutPaymentComponent_Factory","t","ɵɵdirectiveInject","BasketService","CheckoutService","ToastrService","Router","ɵcmp","ɵɵdefineComponent","type","selectors","viewQuery","CheckoutPaymentComponent_Query","ɵɵviewQuery","_t","ɵɵqueryRefresh","ɵɵloadQuery","first","inputs","decls","vars","consts","template","CheckoutPaymentComponent_Template","ɵɵtemplate","ɵɵlistener","CheckoutPaymentComponent_Template_button_click_18_listener","ɵɵproperty","invalid","directives","NgControlStatusGroup","FormGroupDirective","FormGroupName","TextInputComponent","NgControlStatus","FormControlName","NgIf","CdkStepperPrevious","styles"],"mappings":";AAAA,OAAO,KAAKA,EAAZ,MAAoB,eAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,+BAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,qBAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,YAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,iBAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,gBAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,yDAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,iBAApB;AACA,OAAO,KAAKC,EAAZ,MAAoB,sBAApB;AACA,MAAMC,GAAG,GAAG,CAAC,YAAD,CAAZ;AACA,MAAMC,GAAG,GAAG,CAAC,YAAD,CAAZ;AACA,MAAMC,GAAG,GAAG,CAAC,SAAD,CAAZ;;AACA,SAASC,gDAAT,CAA0DC,EAA1D,EAA8DC,GAA9D,EAAmE;AAAE,MAAID,EAAE,GAAG,CAAT,EAAY;AAC7Eb,IAAAA,EAAE,CAACe,uBAAH,CAA2B,CAA3B;AACAf,IAAAA,EAAE,CAACgB,cAAH,CAAkB,CAAlB,EAAqB,MAArB,EAA6B,EAA7B;AACAhB,IAAAA,EAAE,CAACiB,MAAH,CAAU,CAAV;AACAjB,IAAAA,EAAE,CAACkB,YAAH;AACAlB,IAAAA,EAAE,CAACmB,qBAAH;AACH;;AAAC,MAAIN,EAAE,GAAG,CAAT,EAAY;AACV,UAAMO,MAAM,GAAGpB,EAAE,CAACqB,aAAH,EAAf;AACArB,IAAAA,EAAE,CAACsB,SAAH,CAAa,CAAb;AACAtB,IAAAA,EAAE,CAACuB,iBAAH,CAAqBH,MAAM,CAACI,UAA5B;AACH;AAAE;;AACH,SAASC,sCAAT,CAAgDZ,EAAhD,EAAoDC,GAApD,EAAyD;AAAE,MAAID,EAAE,GAAG,CAAT,EAAY;AACnEb,IAAAA,EAAE,CAAC0B,SAAH,CAAa,CAAb,EAAgB,GAAhB,EAAqB,EAArB;AACH;AAAE;;AACH,OAAO,MAAMC,wBAAN,CAA+B;AAClCC,EAAAA,WAAW,CAACC,aAAD,EAAgBC,eAAhB,EAAiCC,MAAjC,EAAyCC,MAAzC,EAAiD;AACxD,SAAKH,aAAL,GAAqBA,aAArB;AACA,SAAKC,eAAL,GAAuBA,eAAvB;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,MAAL,GAAcA,MAAd;AACA,SAAKC,WAAL,GAAmB,KAAKC,QAAL,CAAcC,IAAd,CAAmB,IAAnB,CAAnB;AACA,SAAKC,OAAL,GAAe,KAAf;AACA,SAAKC,eAAL,GAAuB,KAAvB;AACA,SAAKC,eAAL,GAAuB,KAAvB;AACA,SAAKC,YAAL,GAAoB,KAApB;AACH;;AACDC,EAAAA,eAAe,GAAG;AACd,SAAKC,MAAL,GAAcC,MAAM,CAAC,6GAAD,CAApB;AACA,UAAMC,QAAQ,GAAG,KAAKF,MAAL,CAAYE,QAAZ,EAAjB;AACA,SAAKC,UAAL,GAAkBD,QAAQ,CAACE,MAAT,CAAgB,YAAhB,CAAlB;AACA,SAAKD,UAAL,CAAgBE,KAAhB,CAAsB,KAAKC,iBAAL,CAAuBC,aAA7C;AACA,SAAKJ,UAAL,CAAgBK,gBAAhB,CAAiC,QAAjC,EAA2C,KAAKhB,WAAhD;AACA,SAAKiB,UAAL,GAAkBP,QAAQ,CAACE,MAAT,CAAgB,YAAhB,CAAlB;AACA,SAAKK,UAAL,CAAgBJ,KAAhB,CAAsB,KAAKK,iBAAL,CAAuBH,aAA7C;AACA,SAAKE,UAAL,CAAgBD,gBAAhB,CAAiC,QAAjC,EAA2C,KAAKhB,WAAhD;AACA,SAAKmB,OAAL,GAAeT,QAAQ,CAACE,MAAT,CAAgB,SAAhB,CAAf;AACA,SAAKO,OAAL,CAAaN,KAAb,CAAmB,KAAKO,cAAL,CAAoBL,aAAvC;AACA,SAAKI,OAAL,CAAaH,gBAAb,CAA8B,QAA9B,EAAwC,KAAKhB,WAA7C;AACH;;AACDqB,EAAAA,WAAW,GAAG;AACV,SAAKV,UAAL,CAAgBW,OAAhB;AACA,SAAKL,UAAL,CAAgBK,OAAhB;AACA,SAAKH,OAAL,CAAaG,OAAb;AACH;;AACDrB,EAAAA,QAAQ,CAACsB,KAAD,EAAQ;AACZ,QAAIA,KAAK,CAACC,KAAV,EAAiB;AACb,WAAKjC,UAAL,GAAkBgC,KAAK,CAACC,KAAN,CAAYC,OAA9B;AACH,KAFD,MAGK;AACD,WAAKlC,UAAL,GAAkB,IAAlB;AACH;;AACD,YAAQgC,KAAK,CAACG,WAAd;AACI,WAAK,YAAL;AACI,aAAKtB,eAAL,GAAuBmB,KAAK,CAACI,QAA7B;AACA;;AACJ,WAAK,YAAL;AACI,aAAKtB,eAAL,GAAuBkB,KAAK,CAACI,QAA7B;AACA;;AACJ,WAAK,SAAL;AACI,aAAKrB,YAAL,GAAoBiB,KAAK,CAACI,QAA1B;AACA;AATR;AAWH;;AACKC,EAAAA,WAAW,GAAG;AAAA;;AAAA;AAChB,MAAA,KAAI,CAACzB,OAAL,GAAe,IAAf;;AACA,YAAM0B,MAAM,GAAG,KAAI,CAACjC,aAAL,CAAmBkC,qBAAnB,EAAf;;AACA,UAAI;AACA,cAAMC,YAAY,SAAS,KAAI,CAACC,WAAL,CAAiBH,MAAjB,CAA3B;AACA,cAAMI,aAAa,SAAS,KAAI,CAACC,wBAAL,CAA8BL,MAA9B,CAA5B;;AACA,YAAII,aAAa,CAACE,aAAlB,EAAiC;AAC7B,UAAA,KAAI,CAACvC,aAAL,CAAmBwC,YAAnB,CAAgCP,MAAhC;;AACA,gBAAMQ,gBAAgB,GAAG;AAAEC,YAAAA,KAAK,EAAEP;AAAT,WAAzB;;AACA,UAAA,KAAI,CAAChC,MAAL,CAAYwC,QAAZ,CAAqB,CAAC,kBAAD,CAArB,EAA2CF,gBAA3C;AACH,SAJD,MAKK;AACD,UAAA,KAAI,CAACvC,MAAL,CAAY0B,KAAZ,CAAkBS,aAAa,CAACT,KAAd,CAAoBC,OAAtC;AACH;;AACD,QAAA,KAAI,CAACtB,OAAL,GAAe,KAAf;AACH,OAZD,CAaA,OAAOqB,KAAP,EAAc;AACVgB,QAAAA,OAAO,CAACC,GAAR,CAAYjB,KAAZ;AACA,QAAA,KAAI,CAACrB,OAAL,GAAe,KAAf;AACH;AAnBe;AAoBnB;;AACK+B,EAAAA,wBAAwB,CAACL,MAAD,EAAS;AAAA;;AAAA;AACnC,aAAO,MAAI,CAACrB,MAAL,CAAYkC,kBAAZ,CAA+Bb,MAAM,CAACc,YAAtC,EAAoD;AACvDC,QAAAA,cAAc,EAAE;AACZC,UAAAA,IAAI,EAAE,MAAI,CAAClC,UADC;AAEZmC,UAAAA,eAAe,EAAE;AACbC,YAAAA,IAAI,EAAE,MAAI,CAACC,YAAL,CAAkBC,GAAlB,CAAsB,aAAtB,EAAqCA,GAArC,CAAyC,YAAzC,EAAuDC;AADhD;AAFL;AADuC,OAApD,CAAP;AADmC;AAStC;;AACKlB,EAAAA,WAAW,CAACH,MAAD,EAAS;AAAA;;AAAA;AACtB,YAAMsB,aAAa,GAAG,MAAI,CAACC,gBAAL,CAAsBvB,MAAtB,CAAtB;;AACA,aAAO,MAAI,CAAChC,eAAL,CAAqBmC,WAArB,CAAiCmB,aAAjC,EAAgDE,SAAhD,EAAP;AAFsB;AAGzB;;AACDD,EAAAA,gBAAgB,CAACvB,MAAD,EAAS;AACrB,WAAO;AACHyB,MAAAA,QAAQ,EAAEzB,MAAM,CAAC0B,EADd;AAEHC,MAAAA,gBAAgB,EAAE,KAAKR,YAAL,CAAkBC,GAAlB,CAAsB,cAAtB,EAAsCA,GAAtC,CAA0C,gBAA1C,EAA4DC,KAF3E;AAGHO,MAAAA,aAAa,EAAE,KAAKT,YAAL,CAAkBC,GAAlB,CAAsB,aAAtB,EAAqCC;AAHjD,KAAP;AAKH;;AA1FiC;;AA4FtCxD,wBAAwB,CAACgE,IAAzB,GAAgC,SAASC,gCAAT,CAA0CC,CAA1C,EAA6C;AAAE,SAAO,KAAKA,CAAC,IAAIlE,wBAAV,EAAoC3B,EAAE,CAAC8F,iBAAH,CAAqB7F,EAAE,CAAC8F,aAAxB,CAApC,EAA4E/F,EAAE,CAAC8F,iBAAH,CAAqB5F,EAAE,CAAC8F,eAAxB,CAA5E,EAAsHhG,EAAE,CAAC8F,iBAAH,CAAqB3F,EAAE,CAAC8F,aAAxB,CAAtH,EAA8JjG,EAAE,CAAC8F,iBAAH,CAAqB1F,EAAE,CAAC8F,MAAxB,CAA9J,CAAP;AAAwM,CAAvR;;AACAvE,wBAAwB,CAACwE,IAAzB,GAAgC,aAAcnG,EAAE,CAACoG,iBAAH,CAAqB;AAAEC,EAAAA,IAAI,EAAE1E,wBAAR;AAAkC2E,EAAAA,SAAS,EAAE,CAAC,CAAC,sBAAD,CAAD,CAA7C;AAAyEC,EAAAA,SAAS,EAAE,SAASC,8BAAT,CAAwC3F,EAAxC,EAA4CC,GAA5C,EAAiD;AAAE,QAAID,EAAE,GAAG,CAAT,EAAY;AAC9Mb,MAAAA,EAAE,CAACyG,WAAH,CAAehG,GAAf,EAAoB,CAApB;AACAT,MAAAA,EAAE,CAACyG,WAAH,CAAe/F,GAAf,EAAoB,CAApB;AACAV,MAAAA,EAAE,CAACyG,WAAH,CAAe9F,GAAf,EAAoB,CAApB;AACH;;AAAC,QAAIE,EAAE,GAAG,CAAT,EAAY;AACV,UAAI6F,EAAJ;;AACA1G,MAAAA,EAAE,CAAC2G,cAAH,CAAkBD,EAAE,GAAG1G,EAAE,CAAC4G,WAAH,EAAvB,MAA6C9F,GAAG,CAACiC,iBAAJ,GAAwB2D,EAAE,CAACG,KAAxE;AACA7G,MAAAA,EAAE,CAAC2G,cAAH,CAAkBD,EAAE,GAAG1G,EAAE,CAAC4G,WAAH,EAAvB,MAA6C9F,GAAG,CAACqC,iBAAJ,GAAwBuD,EAAE,CAACG,KAAxE;AACA7G,MAAAA,EAAE,CAAC2G,cAAH,CAAkBD,EAAE,GAAG1G,EAAE,CAAC4G,WAAH,EAAvB,MAA6C9F,GAAG,CAACuC,cAAJ,GAAqBqD,EAAE,CAACG,KAArE;AACH;AAAE,GAT4D;AAS1DC,EAAAA,MAAM,EAAE;AAAE7B,IAAAA,YAAY,EAAE;AAAhB,GATkD;AAShB8B,EAAAA,KAAK,EAAE,EATS;AASLC,EAAAA,IAAI,EAAE,CATD;AASIC,EAAAA,MAAM,EAAE,CAAC,CAAC,CAAD,EAAI,MAAJ,EAAY,CAAZ,EAAe,WAAf,CAAD,EAA8B,CAAC,CAAD,EAAI,KAAJ,CAA9B,EAA0C,CAAC,eAAD,EAAkB,aAAlB,EAAiC,CAAjC,EAAoC,YAApC,EAAkD,QAAlD,CAA1C,EAAuG,CAAC,iBAAD,EAAoB,YAApB,EAAkC,CAAlC,EAAqC,OAArC,CAAvG,EAAsJ,CAAC,CAAD,EAAI,YAAJ,EAAkB,OAAlB,CAAtJ,EAAkL,CAAC,CAAD,EAAI,cAAJ,EAAoB,MAApB,CAAlL,EAA+M,CAAC,YAAD,EAAe,EAAf,CAA/M,EAAmO,CAAC,CAAD,EAAI,MAAJ,CAAnO,EAAgP,CAAC,CAAD,EAAI,YAAJ,EAAkB,OAAlB,CAAhP,EAA4Q,CAAC,YAAD,EAAe,EAAf,CAA5Q,EAAgS,CAAC,SAAD,EAAY,EAAZ,CAAhS,EAAiT,CAAC,CAAD,EAAI,YAAJ,EAAkB,QAAlB,EAA4B,yBAA5B,EAAuD,aAAvD,EAAsE,aAAtE,EAAqF,MAArF,CAAjT,EAA+Y,CAAC,oBAAD,EAAuB,EAAvB,EAA2B,CAA3B,EAA8B,KAA9B,EAAqC,qBAArC,CAA/Y,EAA4c,CAAC,CAAD,EAAI,IAAJ,EAAU,eAAV,CAA5c,EAAwe,CAAC,CAAD,EAAI,KAAJ,EAAW,aAAX,EAA0B,CAA1B,EAA6B,UAA7B,EAAyC,OAAzC,CAAxe,EAA2hB,CAAC,CAAD,EAAI,IAAJ,EAAU,gBAAV,CAA3hB,EAAwjB,CAAC,OAAD,EAAU,uBAAV,EAAmC,CAAnC,EAAsC,MAAtC,CAAxjB,EAAumB,CAAC,CAAD,EAAI,aAAJ,CAAvmB,EAA2nB,CAAC,CAAD,EAAI,IAAJ,EAAU,YAAV,EAAwB,SAAxB,CAA3nB,CATZ;AAS4qBC,EAAAA,QAAQ,EAAE,SAASC,iCAAT,CAA2CtG,EAA3C,EAA+CC,GAA/C,EAAoD;AAAE,QAAID,EAAE,GAAG,CAAT,EAAY;AACnzBb,MAAAA,EAAE,CAACgB,cAAH,CAAkB,CAAlB,EAAqB,KAArB,EAA4B,CAA5B,EAA+B,CAA/B,EAAkC,KAAlC,EAAyC,CAAzC,EAA4C,CAA5C,EAA+C,KAA/C,EAAsD,CAAtD;AACAhB,MAAAA,EAAE,CAAC0B,SAAH,CAAa,CAAb,EAAgB,gBAAhB,EAAkC,CAAlC;AACA1B,MAAAA,EAAE,CAACkB,YAAH;AACAlB,MAAAA,EAAE,CAACgB,cAAH,CAAkB,CAAlB,EAAqB,KAArB,EAA4B,CAA5B;AACAhB,MAAAA,EAAE,CAAC0B,SAAH,CAAa,CAAb,EAAgB,KAAhB,EAAuB,CAAvB,EAA0B,CAA1B;AACA1B,MAAAA,EAAE,CAACoH,UAAH,CAAc,CAAd,EAAiBxG,gDAAjB,EAAmE,CAAnE,EAAsE,CAAtE,EAAyE,cAAzE,EAAyF,CAAzF;AACAZ,MAAAA,EAAE,CAACkB,YAAH;AACAlB,MAAAA,EAAE,CAACgB,cAAH,CAAkB,CAAlB,EAAqB,KAArB,EAA4B,CAA5B;AACAhB,MAAAA,EAAE,CAAC0B,SAAH,CAAa,CAAb,EAAgB,KAAhB,EAAuB,CAAvB,EAA0B,CAA1B;AACA1B,MAAAA,EAAE,CAACkB,YAAH;AACAlB,MAAAA,EAAE,CAACgB,cAAH,CAAkB,EAAlB,EAAsB,KAAtB,EAA6B,CAA7B;AACAhB,MAAAA,EAAE,CAAC0B,SAAH,CAAa,EAAb,EAAiB,KAAjB,EAAwB,CAAxB,EAA2B,EAA3B;AACA1B,MAAAA,EAAE,CAACkB,YAAH;AACAlB,MAAAA,EAAE,CAACgB,cAAH,CAAkB,EAAlB,EAAsB,KAAtB,EAA6B,EAA7B,EAAiC,EAAjC,EAAqC,QAArC,EAA+C,EAA/C;AACAhB,MAAAA,EAAE,CAAC0B,SAAH,CAAa,EAAb,EAAiB,GAAjB,EAAsB,EAAtB;AACA1B,MAAAA,EAAE,CAACiB,MAAH,CAAU,EAAV,EAAc,kBAAd;AACAjB,MAAAA,EAAE,CAACkB,YAAH;AACAlB,MAAAA,EAAE,CAACgB,cAAH,CAAkB,EAAlB,EAAsB,QAAtB,EAAgC,EAAhC;AACAhB,MAAAA,EAAE,CAACqH,UAAH,CAAc,OAAd,EAAuB,SAASC,0DAAT,GAAsE;AAAE,eAAOxG,GAAG,CAAC+C,WAAJ,EAAP;AAA2B,OAA1H;AACA7D,MAAAA,EAAE,CAACiB,MAAH,CAAU,EAAV,EAAc,gBAAd;AACAjB,MAAAA,EAAE,CAAC0B,SAAH,CAAa,EAAb,EAAiB,GAAjB,EAAsB,EAAtB;AACA1B,MAAAA,EAAE,CAACoH,UAAH,CAAc,EAAd,EAAkB3F,sCAAlB,EAA0D,CAA1D,EAA6D,CAA7D,EAAgE,GAAhE,EAAqE,EAArE;AACAzB,MAAAA,EAAE,CAACkB,YAAH;AACH;;AAAC,QAAIL,EAAE,GAAG,CAAT,EAAY;AACVb,MAAAA,EAAE,CAACuH,UAAH,CAAc,WAAd,EAA2BzG,GAAG,CAACmE,YAA/B;AACAjF,MAAAA,EAAE,CAACsB,SAAH,CAAa,CAAb;AACAtB,MAAAA,EAAE,CAACuH,UAAH,CAAc,OAAd,EAAuB,cAAvB;AACAvH,MAAAA,EAAE,CAACsB,SAAH,CAAa,CAAb;AACAtB,MAAAA,EAAE,CAACuH,UAAH,CAAc,MAAd,EAAsBzG,GAAG,CAACU,UAA1B;AACAxB,MAAAA,EAAE,CAACsB,SAAH,CAAa,EAAb;AACAtB,MAAAA,EAAE,CAACuH,UAAH,CAAc,UAAd,EAA0BzG,GAAG,CAACsB,OAAJ,IAAetB,GAAG,CAACmE,YAAJ,CAAiBC,GAAjB,CAAqB,aAArB,EAAoCsC,OAAnD,IAA8D,CAAC1G,GAAG,CAACuB,eAAnE,IAAsF,CAACvB,GAAG,CAACwB,eAA3F,IAA8G,CAACxB,GAAG,CAACyB,YAA7I;AACAvC,MAAAA,EAAE,CAACsB,SAAH,CAAa,CAAb;AACAtB,MAAAA,EAAE,CAACuH,UAAH,CAAc,MAAd,EAAsBzG,GAAG,CAACsB,OAA1B;AACH;AAAE,GA3C4D;AA2C1DqF,EAAAA,UAAU,EAAE,CAACpH,EAAE,CAACqH,oBAAJ,EAA0BrH,EAAE,CAACsH,kBAA7B,EAAiDtH,EAAE,CAACuH,aAApD,EAAmEtH,EAAE,CAACuH,kBAAtE,EAA0FxH,EAAE,CAACyH,eAA7F,EAA8GzH,EAAE,CAAC0H,eAAjH,EAAkIxH,EAAE,CAACyH,IAArI,EAA2IxH,EAAE,CAACyH,kBAA9I,CA3C8C;AA2CqHC,EAAAA,MAAM,EAAE,CAAC,qLAAD;AA3C7H,CAArB,CAA9C","sourcesContent":["import * as i0 from \"@angular/core\";\r\nimport * as i1 from \"src/app/basket/basket.service\";\r\nimport * as i2 from \"../checkout.service\";\r\nimport * as i3 from \"ngx-toastr\";\r\nimport * as i4 from \"@angular/router\";\r\nimport * as i5 from \"@angular/forms\";\r\nimport * as i6 from \"../../shared/components/text-input/text-input.component\";\r\nimport * as i7 from \"@angular/common\";\r\nimport * as i8 from \"@angular/cdk/stepper\";\r\nconst _c0 = [\"cardNumber\"];\r\nconst _c1 = [\"cardExpiry\"];\r\nconst _c2 = [\"cardCvc\"];\r\nfunction CheckoutPaymentComponent_ng_container_7_Template(rf, ctx) { if (rf & 1) {\r\n    i0.ɵɵelementContainerStart(0);\r\n    i0.ɵɵelementStart(1, \"span\", 17);\r\n    i0.ɵɵtext(2);\r\n    i0.ɵɵelementEnd();\r\n    i0.ɵɵelementContainerEnd();\r\n} if (rf & 2) {\r\n    const ctx_r1 = i0.ɵɵnextContext();\r\n    i0.ɵɵadvance(2);\r\n    i0.ɵɵtextInterpolate(ctx_r1.cardErrors);\r\n} }\r\nfunction CheckoutPaymentComponent_i_21_Template(rf, ctx) { if (rf & 1) {\r\n    i0.ɵɵelement(0, \"i\", 18);\r\n} }\r\nexport class CheckoutPaymentComponent {\r\n    constructor(basketService, checkoutService, toastr, router) {\r\n        this.basketService = basketService;\r\n        this.checkoutService = checkoutService;\r\n        this.toastr = toastr;\r\n        this.router = router;\r\n        this.cardHandler = this.onChange.bind(this);\r\n        this.loading = false;\r\n        this.cardNumberValid = false;\r\n        this.cardExpiryValid = false;\r\n        this.cardCvcValid = false;\r\n    }\r\n    ngAfterViewInit() {\r\n        this.stripe = Stripe('pk_test_51KsunPL2Qn5rWsPpwSE9amT78iPHDHlkELaBAvApJ4FzNOj4biNmDtAtjx7VNtg788iPtkEQLLiPk158il9n19Xi00UQSa5c1o');\r\n        const elements = this.stripe.elements();\r\n        this.cardNumber = elements.create('cardNumber');\r\n        this.cardNumber.mount(this.cardNumberElement.nativeElement);\r\n        this.cardNumber.addEventListener('change', this.cardHandler);\r\n        this.cardExpiry = elements.create('cardExpiry');\r\n        this.cardExpiry.mount(this.cardExpiryElement.nativeElement);\r\n        this.cardExpiry.addEventListener('change', this.cardHandler);\r\n        this.cardCvc = elements.create('cardCvc');\r\n        this.cardCvc.mount(this.cardCvcElement.nativeElement);\r\n        this.cardCvc.addEventListener('change', this.cardHandler);\r\n    }\r\n    ngOnDestroy() {\r\n        this.cardNumber.destroy();\r\n        this.cardExpiry.destroy();\r\n        this.cardCvc.destroy();\r\n    }\r\n    onChange(event) {\r\n        if (event.error) {\r\n            this.cardErrors = event.error.message;\r\n        }\r\n        else {\r\n            this.cardErrors = null;\r\n        }\r\n        switch (event.elementType) {\r\n            case 'cardNumber':\r\n                this.cardNumberValid = event.complete;\r\n                break;\r\n            case 'cardExpiry':\r\n                this.cardExpiryValid = event.complete;\r\n                break;\r\n            case 'cardCvc':\r\n                this.cardCvcValid = event.complete;\r\n                break;\r\n        }\r\n    }\r\n    async submitOrder() {\r\n        this.loading = true;\r\n        const basket = this.basketService.getCurrentBasketValue();\r\n        try {\r\n            const createdOrder = await this.createOrder(basket);\r\n            const paymentResult = await this.confirmPaymentWithStripe(basket);\r\n            if (paymentResult.paymentIntent) {\r\n                this.basketService.deleteBasket(basket);\r\n                const navigationExtras = { state: createdOrder };\r\n                this.router.navigate(['checkout/success'], navigationExtras);\r\n            }\r\n            else {\r\n                this.toastr.error(paymentResult.error.message);\r\n            }\r\n            this.loading = false;\r\n        }\r\n        catch (error) {\r\n            console.log(error);\r\n            this.loading = false;\r\n        }\r\n    }\r\n    async confirmPaymentWithStripe(basket) {\r\n        return this.stripe.confirmCardPayment(basket.clientSecret, {\r\n            payment_method: {\r\n                card: this.cardNumber,\r\n                billing_details: {\r\n                    name: this.checkoutForm.get('paymentForm').get('nameOnCard').value\r\n                }\r\n            }\r\n        });\r\n    }\r\n    async createOrder(basket) {\r\n        const orderToCreate = this.getOrderToCreate(basket);\r\n        return this.checkoutService.createOrder(orderToCreate).toPromise();\r\n    }\r\n    getOrderToCreate(basket) {\r\n        return {\r\n            basketId: basket.id,\r\n            deliveryMethodId: this.checkoutForm.get('deliveryForm').get('deliveryMethod').value,\r\n            shipToAddress: this.checkoutForm.get('addressForm').value\r\n        };\r\n    }\r\n}\r\nCheckoutPaymentComponent.ɵfac = function CheckoutPaymentComponent_Factory(t) { return new (t || CheckoutPaymentComponent)(i0.ɵɵdirectiveInject(i1.BasketService), i0.ɵɵdirectiveInject(i2.CheckoutService), i0.ɵɵdirectiveInject(i3.ToastrService), i0.ɵɵdirectiveInject(i4.Router)); };\r\nCheckoutPaymentComponent.ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent({ type: CheckoutPaymentComponent, selectors: [[\"app-checkout-payment\"]], viewQuery: function CheckoutPaymentComponent_Query(rf, ctx) { if (rf & 1) {\r\n        i0.ɵɵviewQuery(_c0, 7);\r\n        i0.ɵɵviewQuery(_c1, 7);\r\n        i0.ɵɵviewQuery(_c2, 7);\r\n    } if (rf & 2) {\r\n        let _t;\r\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardNumberElement = _t.first);\r\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardExpiryElement = _t.first);\r\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardCvcElement = _t.first);\r\n    } }, inputs: { checkoutForm: \"checkoutForm\" }, decls: 22, vars: 5, consts: [[1, \"mt-4\", 3, \"formGroup\"], [1, \"row\"], [\"formGroupName\", \"paymentForm\", 1, \"form-group\", \"col-12\"], [\"formControlName\", \"nameOnCard\", 3, \"label\"], [1, \"form-group\", \"col-6\"], [1, \"form-control\", \"py-3\"], [\"cardNumber\", \"\"], [4, \"ngIf\"], [1, \"form-group\", \"col-3\"], [\"cardExpiry\", \"\"], [\"cardCvc\", \"\"], [1, \"float-none\", \"d-flex\", \"justify-content-between\", \"flex-column\", \"flex-lg-row\", \"mb-5\"], [\"cdkStepperPrevious\", \"\", 1, \"btn\", \"btn-outline-primary\"], [1, \"fa\", \"fa-angle-left\"], [1, \"btn\", \"btn-primary\", 3, \"disabled\", \"click\"], [1, \"fa\", \"fa-angle-right\"], [\"class\", \"fa fa-spinner fa-spin\", 4, \"ngIf\"], [1, \"text-danger\"], [1, \"fa\", \"fa-spinner\", \"fa-spin\"]], template: function CheckoutPaymentComponent_Template(rf, ctx) { if (rf & 1) {\r\n        i0.ɵɵelementStart(0, \"div\", 0)(1, \"div\", 1)(2, \"div\", 2);\r\n        i0.ɵɵelement(3, \"app-text-input\", 3);\r\n        i0.ɵɵelementEnd();\r\n        i0.ɵɵelementStart(4, \"div\", 4);\r\n        i0.ɵɵelement(5, \"div\", 5, 6);\r\n        i0.ɵɵtemplate(7, CheckoutPaymentComponent_ng_container_7_Template, 3, 1, \"ng-container\", 7);\r\n        i0.ɵɵelementEnd();\r\n        i0.ɵɵelementStart(8, \"div\", 8);\r\n        i0.ɵɵelement(9, \"div\", 5, 9);\r\n        i0.ɵɵelementEnd();\r\n        i0.ɵɵelementStart(11, \"div\", 8);\r\n        i0.ɵɵelement(12, \"div\", 5, 10);\r\n        i0.ɵɵelementEnd()()();\r\n        i0.ɵɵelementStart(14, \"div\", 11)(15, \"button\", 12);\r\n        i0.ɵɵelement(16, \"i\", 13);\r\n        i0.ɵɵtext(17, \" Back to Review \");\r\n        i0.ɵɵelementEnd();\r\n        i0.ɵɵelementStart(18, \"button\", 14);\r\n        i0.ɵɵlistener(\"click\", function CheckoutPaymentComponent_Template_button_click_18_listener() { return ctx.submitOrder(); });\r\n        i0.ɵɵtext(19, \" Submit order \");\r\n        i0.ɵɵelement(20, \"i\", 15);\r\n        i0.ɵɵtemplate(21, CheckoutPaymentComponent_i_21_Template, 1, 0, \"i\", 16);\r\n        i0.ɵɵelementEnd()();\r\n    } if (rf & 2) {\r\n        i0.ɵɵproperty(\"formGroup\", ctx.checkoutForm);\r\n        i0.ɵɵadvance(3);\r\n        i0.ɵɵproperty(\"label\", \"Name on card\");\r\n        i0.ɵɵadvance(4);\r\n        i0.ɵɵproperty(\"ngIf\", ctx.cardErrors);\r\n        i0.ɵɵadvance(11);\r\n        i0.ɵɵproperty(\"disabled\", ctx.loading || ctx.checkoutForm.get(\"paymentForm\").invalid || !ctx.cardNumberValid || !ctx.cardExpiryValid || !ctx.cardCvcValid);\r\n        i0.ɵɵadvance(3);\r\n        i0.ɵɵproperty(\"ngIf\", ctx.loading);\r\n    } }, directives: [i5.NgControlStatusGroup, i5.FormGroupDirective, i5.FormGroupName, i6.TextInputComponent, i5.NgControlStatus, i5.FormControlName, i7.NgIf, i8.CdkStepperPrevious], styles: [\"\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsImZpbGUiOiJjaGVja291dC1wYXltZW50LmNvbXBvbmVudC5zY3NzIn0= */\"] });\r\n"]},"metadata":{},"sourceType":"module"}